<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Torneo GToro 3.0 - Olimpiadas 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        onSnapshot,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      window.firebase = {
        initializeApp,
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        getFirestore,
        doc,
        getDoc,
        setDoc,
        onSnapshot,
        updateDoc,
      };
    </script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        width: 90%;
        max-width: 600px;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, createContext, useContext } = React;
      const { initializeApp } = window.firebase;
      const {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } = window.firebase;
      const { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } =
        window.firebase;

      // --- CONFIGURACIÓN DE FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyD5nk9wzovy3btArx4dBgW2eSXkkB-sYFk",
        authDomain: "gtoro-olimpiadas-2025.firebaseapp.com",
        projectId: "gtoro-olimpiadas-2025",
        storageBucket: "gtoro-olimpiadas-2025.appspot.com",
        messagingSenderId: "564978583170",
        appId: "1:564978583170:web:e1f2741ffb1a8aa6fdd69b",
      };

      // --- VERIFICACIÓN DE CONFIGURACIÓN ---
      function checkFirebaseConfig() {
        if (firebaseConfig.apiKey === "TU_API_KEY" || !firebaseConfig.apiKey) {
          const root = document.getElementById("root");
          root.innerHTML = `
                    <div style="padding: 2rem; text-align: center; font-family: sans-serif; background-color: #fff1f2; border: 1px solid #ffdde0; margin: 2rem; border-radius: 8px;">
                        <h1 style="color: #be123c; font-size: 1.5rem; margin-bottom: 1rem;">Error de Configuración</h1>
                        <p>No has configurado tus credenciales de Firebase en el archivo <strong>index.html</strong>.</p>
                        <p>Por favor, reemplaza el objeto <code>firebaseConfig</code> con las claves de tu proyecto de Firebase para continuar.</p>
                    </div>
                `;
          return false;
        }
        return true;
      }

      if (checkFirebaseConfig()) {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONTEXTO DE AUTENTICACIÓN ---
        const AuthContext = createContext(null);

        const AuthProvider = ({ children }) => {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
              setUser(user);
              setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          const value = { user, loading };

          return (
            <AuthContext.Provider value={value}>
              {!loading && children}
            </AuthContext.Provider>
          );
        };

        const useAuth = () => {
          return useContext(AuthContext);
        };

        // --- DATOS INICIALES DEL TORNEO ---
        const TORNEO_ID_GLOBAL = "olimpiadas-2025-gtoro";

        const initialTournamentData = {
          eventName: "Olimpiadas 2025 - GToro 3.0",
          publicViewId:
            "tok-" +
            Math.random().toString(36).substr(2) +
            Math.random().toString(36).substr(2),
          teams: {}, // Los equipos ahora se gestionan dinámicamente
          matches: [],
        };

        const PRESET_COLORS = [
          "bg-red-500",
          "bg-blue-500",
          "bg-green-500",
          "bg-yellow-500",
          "bg-violet-500",
          "bg-orange-500",
          "bg-pink-500",
          "bg-cyan-500",
        ];

        // --- COMPONENTES ---
        function PublicView() {
          const [torneo, setTorneo] = useState(null);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const publicId = window.location.pathname.split("/")[2];

          useEffect(() => {
            const docRef = doc(db, "tournaments", TORNEO_ID_GLOBAL);
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
              if (
                docSnap.exists() &&
                docSnap.data().publicViewId === publicId
              ) {
                setTorneo(docSnap.data());
                setError(null);
              } else {
                setError("Torneo no encontrado o enlace inválido.");
              }
              setLoading(false);
            });
            return () => unsubscribe();
          }, [publicId]);

          if (loading)
            return (
              <div className="flex justify-center items-center h-screen">
                <div className="loader"></div>
              </div>
            );
          if (error)
            return (
              <div className="text-center mt-10 text-red-500">{error}</div>
            );

          const rankedTeams = torneo
            ? Object.values(torneo.teams).sort((a, b) => b.points - a.points)
            : [];
          const sortedMatches =
            torneo && torneo.matches
              ? [...torneo.matches].sort(
                  (a, b) => (a.partido || a.round) - (b.partido || b.round)
                )
              : [];

          const getTeamColor = (index) => {
            return PRESET_COLORS[index % PRESET_COLORS.length] || "bg-gray-500";
          };

          return (
            <div className="container mx-auto p-4 md:p-8">
              <header className="text-center mb-8">
                <h1 className="text-4xl md:text-5xl font-bold text-gray-800">
                  {torneo.eventName}
                </h1>
                <p className="text-gray-600 mt-2">Resultados en Vivo</p>
              </header>
              <div className="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 className="text-2xl font-bold mb-4 text-center">
                  Tabla de Posiciones
                </h2>
                <ol className="space-y-3">
                  {rankedTeams.map((team, index) => (
                    <li
                      key={team.name}
                      className={`flex justify-between items-center p-4 rounded-lg text-white shadow ${getTeamColor(
                        index
                      )}`}
                    >
                      <div className="flex items-center">
                        <span className="text-lg font-bold mr-4">
                          {index + 1}
                        </span>
                        <span className="text-xl">{team.name}</span>
                      </div>
                      <span className="text-2xl font-bold">
                        {team.points} Pts
                      </span>
                    </li>
                  ))}
                </ol>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4 text-center">
                  Fixture y Resultados
                </h2>
                <div className="space-y-4">
                  {sortedMatches.length > 0 ? (
                    sortedMatches.map((match) => (
                      <div
                        key={match.id}
                        className="border border-gray-200 p-4 rounded-lg shadow-sm"
                      >
                        <p className="font-bold text-lg">
                          Partido {match.partido || match.round}: Alianza{" "}
                          {match.alliance.join(" y ")}
                        </p>
                        {match.finished ? (
                          <div>
                            <p className="text-green-600 font-bold text-xl">
                              {match.score} Puntos
                            </p>
                            {match.commentary && (
                              <div className="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-sm font-semibold text-blue-800">
                                  ✨ Comentario de la IA:
                                </p>
                                <p className="text-blue-700 italic">
                                  "{match.commentary}"
                                </p>
                              </div>
                            )}
                          </div>
                        ) : (
                          <p className="text-orange-500">Pendiente</p>
                        )}
                      </div>
                    ))
                  ) : (
                    <p className="text-center text-gray-500">
                      El fixture aún no ha sido cargado.
                    </p>
                  )}
                </div>
              </div>
            </div>
          );
        }

        function ScoreMatchForm({ match, onSave, onCancel }) {
          /* ... (sin cambios) ... */
        }
        function AddMatchForm({ teamNames, onAddMatch, existingMatches }) {
          /* ... (sin cambios) ... */
        }
        function ConfirmModal({ message, onConfirm, onCancel }) {
          /* ... (sin cambios) ... */
        }

        function AdminDashboard() {
          const [torneo, setTorneo] = useState(null);
          const [geminiApiKey, setGeminiApiKey] = useState(
            () => localStorage.getItem("geminiApiKey") || ""
          );
          const [loadingCommentary, setLoadingCommentary] = useState(null);
          const [scoringMatch, setScoringMatch] = useState(null);
          const [showResetConfirm, setShowResetConfirm] = useState(false);
          const [newTeamName, setNewTeamName] = useState("");
          const [teamError, setTeamError] = useState("");

          useEffect(() => {
            const docRef = doc(db, "tournaments", TORNEO_ID_GLOBAL);
            const unsubscribe = onSnapshot(
              docRef,
              (docSnap) => {
                if (docSnap.exists()) {
                  setTorneo(docSnap.data());
                } else {
                  setDoc(docRef, initialTournamentData).then(() =>
                    setTorneo(initialTournamentData)
                  );
                }
              },
              (error) => console.error("Error fetching tournament:", error)
            );
            return () => unsubscribe();
          }, []);

          const handleAddTeam = (e) => {
            e.preventDefault();
            setTeamError("");
            const trimmedName = newTeamName.trim();
            if (!trimmedName) {
              setTeamError("El nombre del equipo no puede estar vacío.");
              return;
            }
            if (torneo.teams[trimmedName]) {
              setTeamError("Ya existe un equipo con este nombre.");
              return;
            }
            const updatedTeams = {
              ...torneo.teams,
              [trimmedName]: { name: trimmedName, points: 0 },
            };
            updateTournament({ teams: updatedTeams });
            setNewTeamName("");
          };

          const handleDeleteTeam = (teamName) => {
            if (
              !window.confirm(
                `¿Seguro que quieres eliminar el equipo "${teamName}"? También se eliminarán todos los partidos en los que participa.`
              )
            ) {
              return;
            }

            const updatedTeams = { ...torneo.teams };
            delete updatedTeams[teamName];

            const updatedMatches = torneo.matches.filter(
              (match) => !match.alliance.includes(teamName)
            );

            // Recalcular puntos
            Object.keys(updatedTeams).forEach((name) => {
              updatedTeams[name].points = 0;
            });
            updatedMatches.forEach((match) => {
              if (match.finished) {
                match.alliance.forEach((name) => {
                  if (updatedTeams[name]) {
                    updatedTeams[name].points += match.score;
                  }
                });
              }
            });

            updateTournament({ teams: updatedTeams, matches: updatedMatches });
          };

          const updateTournament = async (newData) => {
            const docRef = doc(db, "tournaments", TORNEO_ID_GLOBAL);
            await updateDoc(docRef, newData);
          };

          const handleAddMatch = (newMatch) => {
            const updatedMatches = [...(torneo.matches || []), newMatch];
            updateTournament({ matches: updatedMatches });
          };

          const handleSaveScore = (matchId, newScore, details) => {
            const updatedMatches = torneo.matches.map((m) =>
              m.id === matchId
                ? { ...m, finished: true, score: newScore, details }
                : m
            );

            const updatedTeams = JSON.parse(JSON.stringify(torneo.teams));
            Object.keys(updatedTeams).forEach((teamName) => {
              updatedTeams[teamName].points = 0;
            });
            updatedMatches.forEach((m) => {
              if (m.finished) {
                m.alliance.forEach((teamName) => {
                  if (updatedTeams[teamName]) {
                    updatedTeams[teamName].points += m.score;
                  }
                });
              }
            });

            updateTournament({ matches: updatedMatches, teams: updatedTeams });
            setScoringMatch(null);
          };

          const generateCommentary = async (matchId) => {
            /* ... (sin cambios) ... */
          };

          const copyPublicLink = () => {
            if (!torneo || !torneo.publicViewId) return;
            const link = `${window.location.origin}/torneo/${torneo.publicViewId}`;
            navigator.clipboard
              .writeText(link)
              .then(() => alert("Enlace copiado al portapapeles!"));
          };

          const handleResetTournament = async () => {
            const newId =
              "tok-" +
              Math.random().toString(36).substr(2) +
              Math.random().toString(36).substr(2);
            const docRef = doc(db, "tournaments", TORNEO_ID_GLOBAL);
            await setDoc(docRef, {
              ...initialTournamentData,
              publicViewId: newId,
              teams: {},
            });
            setShowResetConfirm(false);
            alert(
              "¡El torneo ha sido reiniciado! El enlace público ha cambiado, no olvides copiarlo de nuevo."
            );
          };

          if (!torneo)
            return (
              <div className="flex justify-center items-center h-screen">
                <div className="loader"></div>
              </div>
            );

          const sortedMatches = [...(torneo.matches || [])].sort(
            (a, b) =>
              (a.partido || a.round) - (b.partido || b.round) ||
              a.id.localeCompare(b.id)
          );

          return (
            <div className="container mx-auto p-4 md:p-8">
              {scoringMatch && (
                <ScoreMatchForm
                  match={scoringMatch}
                  onSave={handleSaveScore}
                  onCancel={() => setScoringMatch(null)}
                />
              )}
              {showResetConfirm && (
                <ConfirmModal
                  message="¿Estás seguro de que quieres reiniciar todo el torneo? Se borrarán todos los equipos, partidos y puntajes permanentemente."
                  onConfirm={handleResetTournament}
                  onCancel={() => setShowResetConfirm(false)}
                />
              )}
              <header className="flex flex-wrap justify-between items-center mb-8 gap-4">
                <h1 className="text-2xl md:text-3xl font-bold">
                  Panel de Administración
                </h1>
                <div>
                  <button
                    onClick={copyPublicLink}
                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mr-4 transition"
                  >
                    Copiar Enlace
                  </button>
                  <button
                    onClick={() => signOut(auth)}
                    className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition"
                  >
                    Cerrar Sesión
                  </button>
                </div>
              </header>

              <div className="space-y-8">
                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h2 className="text-xl font-bold mb-2">
                    ✨ Configuración de IA (Gemini)
                  </h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Ingresa tu API Key de Google Gemini para habilitar la
                    generación de resúmenes de partidos.
                  </p>
                  <input
                    type="password"
                    value={geminiApiKey}
                    onChange={(e) => {
                      setGeminiApiKey(e.target.value);
                      localStorage.setItem("geminiApiKey", e.target.value);
                    }}
                    placeholder="Introduce tu Gemini API Key"
                    className="w-full px-3 py-2 border rounded-md"
                  />
                </div>

                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h2 className="text-2xl font-bold mb-4">
                    Gestión de Equipos
                  </h2>
                  <form onSubmit={handleAddTeam} className="flex gap-2 mb-4">
                    <input
                      type="text"
                      value={newTeamName}
                      onChange={(e) => setNewTeamName(e.target.value)}
                      placeholder="Nombre del nuevo equipo"
                      className="flex-grow px-3 py-2 border rounded-md"
                    />
                    <button
                      type="submit"
                      className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md"
                    >
                      Añadir Equipo
                    </button>
                  </form>
                  {teamError && (
                    <p className="text-red-500 text-sm mb-4">{teamError}</p>
                  )}
                  <ul className="space-y-2">
                    {Object.values(torneo.teams).map((team) => (
                      <li
                        key={team.name}
                        className="flex justify-between items-center p-2 bg-gray-50 rounded-md"
                      >
                        <span>{team.name}</span>
                        <button
                          onClick={() => handleDeleteTeam(team.name)}
                          className="text-red-500 hover:text-red-700 font-semibold"
                        >
                          Eliminar
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h2 className="text-2xl font-bold mb-4">
                    Gestión de Partidos
                  </h2>
                  <AddMatchForm
                    teamNames={Object.keys(torneo.teams)}
                    onAddMatch={handleAddMatch}
                    existingMatches={torneo.matches || []}
                  />
                  <div className="mt-6 space-y-4">
                    {sortedMatches.map((match) => (
                      <div
                        key={match.id}
                        className="border-t mt-4 pt-4 flex justify-between items-center flex-wrap gap-2"
                      >
                        <div>
                          <p className="font-bold">
                            Partido {match.partido || match.round}:{" "}
                            {match.alliance.join(" y ")}
                          </p>
                          <p
                            className={
                              match.finished
                                ? "text-green-600"
                                : "text-orange-500"
                            }
                          >
                            {match.finished
                              ? `Finalizado: ${match.score} pts`
                              : "Pendiente"}
                          </p>
                          {match.commentary && (
                            <p className="text-sm italic mt-1 text-gray-600">
                              "{match.commentary}"
                            </p>
                          )}
                        </div>
                        <div className="flex gap-2 flex-shrink-0">
                          <button
                            onClick={() => setScoringMatch(match)}
                            className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm"
                          >
                            {match.finished ? "Editar" : "Puntuar"}
                          </button>
                          {match.finished && (
                            <button
                              onClick={() => generateCommentary(match.id)}
                              disabled={loadingCommentary === match.id}
                              className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded text-sm disabled:bg-gray-400"
                            >
                              {loadingCommentary === match.id ? "..." : "✨ IA"}
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                  <h2 className="text-xl font-bold mb-2">Zona de Peligro</h2>
                  <p className="text-sm text-gray-600 mb-4">
                    Esta acción no se puede deshacer. Se borrarán todos los
                    equipos, puntajes y partidos actuales.
                  </p>
                  <button
                    onClick={() => setShowResetConfirm(true)}
                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition"
                  >
                    Reiniciar Torneo
                  </button>
                </div>
              </div>
            </div>
          );
        }

        function Login() {
          /* ... (sin cambios) ... */
        }

        function App() {
          const { user, loading } = useAuth();
          const path = window.location.pathname;

          if (loading) {
            return (
              <div className="flex justify-center items-center h-screen">
                <div className="loader"></div>
              </div>
            );
          }

          if (path.startsWith("/torneo/")) {
            return <PublicView />;
          }

          if (path.startsWith("/login")) {
            return user ? <AdminDashboard /> : <Login />;
          }

          return user ? <AdminDashboard /> : <Login />;
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(
          <AuthProvider>
            <App />
          </AuthProvider>
        );
      }
    </script>
  </body>
</html>
